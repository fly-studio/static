/*! jquery.uploader.js 2016-10-28 15:38:45*/
!function(e){if(e.UPLOADER_LANGUAGE={close:"\u5173\u95ed",drop_container:"\u62d6\u5230\u6587\u4ef6\u5230\u8fd9\u91cc",drop_tips:"\u652f\u6301\u4eceWindows\u4e2d\u62d6\u52a8\u6587\u4ef6\u5230\u8fd9\u91cc\u4e0a\u4f20\uff08\u9700\u73b0\u4ee3\u6d4f\u89c8\u5668\uff09",drop_button:"\u62d6\u653e\u6587\u4ef6",select_file:"\u9009\u62e9\u6587\u4ef6",ctrl_v_tips:"\u53ef\u4ee5\u4f7f\u7528Ctrl+V\u76f4\u63a5\u7c98\u8d34\u622a\u56fe\uff08\u9700\u73b0\u4ee3\u6d4f\u89c8\u5668\uff09",ctrl_v_button:"Ctrl+V \u622a\u56fe",resize:"\u56fe\u7247\u4f1a\u81ea\u52a8\u7b49\u6bd4\u7f29\u653e\u81f3\uff1a{0} (\u4ec5jpg)",uploading:"\u6b63\u5728\u4e0a\u4f20\u6587\u4ef6...",success:"\u4e0a\u4f20\u6210\u529f!",rotate_right:"\u5411\u53f3\u65cb\u8f6c",rotate_left:"\u5411\u5de6\u65cb\u8f6c",loading:"\u6b63\u5728\u8f7d\u5165...",reading:"\u6587\u4ef6\u8bfb\u53d6\u4e2d...",filetype:"\u8bf7\u4e0a\u4f20{0}\u6587\u4ef6!",filenum_limite:"\u53ea\u5141\u8bb8\u4e0a\u4f20{0}\u4e2a\u6587\u4ef6\uff0c\u8bf7\u5220\u51cf\u540e\u91cd\u8bd5!",hashing:"\u6b63\u5728\u6548\u9a8c\u6587\u4ef6...",hash_success:"\u4e91\u7aef\u6587\u4ef6\u5df2\u5b58\u5728\uff0c\u6587\u4ef6\u79d2\u4f20\u6210\u529f!",error:"\u5931\u8d25",num_limit:"\u53ea\u80fd\u4e0a\u4f20{0}\u4e2a\u6587\u4ef6!",allsize_limit:"\u6587\u4ef6\u603b\u5927\u5c0f\u8d85\u51fa!",filesize_limite:"\u6587\u4ef6\u5927\u5c0f\u8d85\u51fa {0}!",duplicate:"\u4e0a\u4f20\u961f\u5217\u4e2d\u6709\u91cd\u590d\u6587\u4ef6!"},"undefined"==typeof e.baseuri)throw"this javascript file need behind 'common.js'";var t=document.getElementsByTagName("script"),a=e.deparam.querystring(t[t.length-1].src);e.session_id=a.session_id,e.fn.extend({uploader:function(t,a,r,i,s,l){t!==!0&&(t=e.isUndefined(t)?0:parseFloat(t)),a=e.isUndefined(a)?0:parseFloat(a),r=e.isUndefined(r)?2097152:r,i=e.isUndefined(i)?"jpg,jpeg,png,bmp,gif,webp,svg":i.toLowerCase(),s=isNaN(s)?1:parseInt(s);var n=["jpg","jpeg","png","bmp","gif","webp","svg"];return this.each(function(){var o=e(this),d=o.prop("flex_uploader")?o.prop("flex_uploader"):{};if(d&&d.uploader&&(delete d.uploader,d.$container.remove(),o.prop("flex_uploader",{})),t!==!0){var p={},u=function(){return rand(1e4,99999)},c="uploader-id-"+u(),g="pick-id-"+u(),f=c+"-progresses",m=c+"-thumbnails";d.$container=e('<div class="uploader-container" id="'+c+'"><div class="drop-tips text-info"><h2>'+e.UPLOADER_LANGUAGE.drop_container+'</h2><br /><br /><div class="btn btn-info" onclick="javascript:jQuery(this).parent().hide().parent(\'.uploader-container\').removeClass(\'webuploader-dnd-over\');"><i class="glyphicon glyphicon-remove"></i> '+e.UPLOADER_LANGUAGE.close+'</div></div>\t\t\t\t\t<div class="pull-left"><span id="'+g+'">'+e.UPLOADER_LANGUAGE.select_file+"(\u2264 "+bytesToSize(r)+')</span></div><div class="pull-left tags">&nbsp;<span class="label label-success">.'+i.replace(/,/g,'</span>&nbsp;<span class="label label-success">.')+'</span>&nbsp;<span class="label label-warning enable-tooltip" data-placement="top" title="'+e.UPLOADER_LANGUAGE.ctrl_v_tips+'"><small class="glyphicon glyphicon-info-sign"></small> '+e.UPLOADER_LANGUAGE.ctrl_v_button+'</span>&nbsp;<span class="label label-warning enable-tooltip" data-placement="top" title="'+e.UPLOADER_LANGUAGE.drop_container+'"><small class="glyphicon glyphicon-info-sign"></small> '+e.UPLOADER_LANGUAGE.drop_button+"</span>"+(t>0&&a>0?"<br /><small>&nbsp;"+e.UPLOADER_LANGUAGE.resize.replace("{0}",t.toString().toHTML()+"x"+a.toString().toHTML())+"</small>":"")+'</div><div class="clearfix"></div>\t\t\t\t\t<div id="'+f+'" class="progresses"></div><div class="clearfix"></div>\t\t\t\t\t<div id="'+m+'" class="thumbnails row"></div><div class="clearfix"></div></div>').insertAfter(o),e.fn.tooltip&&e(".enable-tooltip",d.$container).tooltip(),d.uploader=WebUploader.create({swf:e.baseuri+"static/js/webuploader/Uploader.swf",server:e.baseuri+"attachment/uploader_query?of=json",pick:{id:"#"+g,multiple:!0},formData:e.extend(e.session_id?{PHPSESSIONID:e.session_id}:{},e.csrf?{_token:e.csrf}:{},{}),fileVal:"Filedata",method:"POST",sendAsBinary:!1,fileNumLimit:0,fileSingleSizeLimit:r,duplicate:!1,accept:{title:e.UPLOADER_LANGUAGE.select_file,extensions:i,mimeTypes:"undefined"!=typeof mimeType?i.split(",").map(function(e){return mimeType.lookup("name."+e)}).join(","):"*/*"},prepareNextFile:!0,chunkSize:5242880,chunkRetry:5,chunked:!0,threads:3,dnd:"#"+c,disableGlobalDnd:!0,paste:document.body,thumb:{width:75,height:75,quality:70,allowMagnify:!1,crop:!0},resize:!1,compress:null}),t>0&&a>0&&d.uploader.option("compress",{width:t,height:a,quality:100,allowMagnify:!1,crop:!1,preserveHeaders:!0,noCompressIfLarger:!0,compressSize:0});var h={},v=function(t){return h[t.id]||(h[t.id]=e('<div class="media alert alert-warning fade in"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\t\t\t\t\t\t\t<div class="media-left media-middle"><img class="media-object" src="" alt=""></div>\t\t\t\t\t\t\t<div class="media-body"><h4 class="media-heading">'+t.name.toHTML()+"("+bytesToSize(t.size)+')</h4>\t\t\t\t\t\t\t<div class="media-message"></div>\t\t\t\t\t\t\t<div class="progress">\t\t\t\t\t\t\t\t<div class="progress-bar progress-bar-warning progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">\t\t\t\t\t\t\t\t\t<span class=""></span>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>').appendTo("#"+f).on("closed.bs.alert",function(){"complete"==t.getStatus()?v(t).remove():v(t).cancel()})),{init:function(){return h[t.id].removeClass("alert-info alert-danger alert-success alert-warning"),this},initProgress:function(){e(".progress-bar",h[t.id]).removeClass("progress-bar-info progress-bar-danger progress-bar-success progress-bar-warning")},thumb:function(){d.uploader.makeThumb(t,function(a,r){e(".media-object",h[t.id]).attr("src",a?e.baseuri+"placeholder?text="+t.ext+"&size=75x75&fontsize=35":r)})},name:function(a){return e(".progressName",h[t.id]).html(a.toHTML()),this},message:function(a){return e(".media-message",h[t.id]).html(a),this},error:function(a){return this.init(),this.initProgress(),t.setStatus("invalid"),h[t.id].addClass("alert-danger"),e(".progress-bar",h[t.id]).addClass("progress-bar-danger"),this.message(a)},progressing:function(a,r){this.init(),this.initProgress(),h[t.id].addClass("alert-info"),a=a.toFixed(2);var i=e(".progress-bar",h[t.id]).width(a+"%");return e(".progress-bar span",h[t.id]).text(a+"%"),a<20?i.addClass("progress-bar-warning"):a<95?i.addClass("progress-bar-info"):i.addClass("progress-bar-success"),a<100?i.addClass("active"):i.removeClass("active"),this.message(e.UPLOADER_LANGUAGE.uploading)},success:function(){return this.progressing(100),this.init(),h[t.id].addClass("alert-success"),h[t.id].delay(1500).queue(function(){e(this).alert("close").dequeue()}),this.message(e.UPLOADER_LANGUAGE.success)},cancel:function(){return d.uploader.cancelFile(t),this.remove()},remove:function(){return h[t.id].remove(),delete h[t.id],this}}},b={},A=function(t,a,r){if(t&&!b[t])if(b[t]=e('<div class="col-xs-6 col-md-4 alert"><div class="thumbnail">\t\t\t\t\t\t\t<div class="file-panel"><span class="cancel" data-dismiss="alert" aria-label="Close">'+e.UPLOADER_LANGUAGE.close+'</span><span class="rotateRight">'+e.UPLOADER_LANGUAGE.rotate_right+'</span><span class="rotateLeft">'+e.UPLOADER_LANGUAGE.rotate_left+'</span></div>\t\t\t\t\t\t\t<a href="'+e.baseuri+"attachment?id="+t+'"  target="_blank"><img src="'+e.baseuri+"placeholder?size=300x200&text="+encodeURIComponent(e.UPLOADER_LANGUAGE.loading)+'" alt="" class="img-responsive center-block"  onerror="this.src=\''+e.baseuri+"placeholder?size=300x200&text='+encodeURIComponent('"+e.UPLOADER_LANGUAGE.reading+'\');"></a>\t\t\t\t\t\t\t<div class="caption">        \t\t\t\t\t<h4><span class="title">'+(a?a.toHTML():"")+'</span><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></h4>\t\t\t\t\t\t\t</div><div class="clearfix"></div>\t\t\t\t\t\t\t</div><div class="clearfix"></div></div>').appendTo("#"+m).on("closed.bs.alert",function(){A(t).remove()}),e(".rotateLeft,.rotateRight",b[t]).on("click",function(){var a=parseInt(b[t].data("rotation"))||0;a+=e(this).is(".rotateLeft")?-90:90,deg="rotate("+a+"deg)",e("img",b[t]).css(e.supportTransition?{"-webkit-transform":deg,"-mos-transform":deg,"-o-transform":deg,transform:deg}:{filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(a/90%4+4)%4+")"}),b[t].data("rotation",a)}),r){var i=n.indexOf(r.toLowerCase())>-1?e.baseuri+"attachment/preview?id="+t:e.baseuri+"placeholder?size=300x200&text="+encodeURIComponent(r);e("img",b[t]).attr("src",i)}else e.GET(e.baseuri+"attachment/info?id="+t,null,function(a){if("success"==a.result&&a.data.ext){var r=n.indexOf(a.data.ext.toLowerCase())>-1?e.baseuri+"attachment/preview?id="+t:e.baseuri+"placeholder?size=300x200&text="+encodeURIComponent(a.data.ext);e(".title",b[t]).text(a.data.displayname),e("img",b[t]).attr("src",r)}});return{build:function(){return o.triggerHandler("uploader.previewing",[this.getFile(),t,_().get()])===!1?this:(_().add(t),o.triggerHandler("uploader.previewed",[this.getFile(),t,_().get()]),this)},remove:function(){var e=this.getFile();return o.triggerHandler("uploader.removing",[e,t,_().get()])===!1?this:(e&&d.uploader.removeFile(e,!0),_().remove(t),b[t].remove(),delete b[t],o.triggerHandler("uploader.removed",[e,t,_().get()]),this)},setFile:function(e){return b[t].data("file",e),this},getFile:function(){return b[t].data("file")},removeAll:function(){for(var e in b)A(e).remove()},rebuildAll:function(){files=d.uploader.getFiles();for(var e=0;e<files.length;e++)d.uploader.removeFile(files[e],!0);this.removeAll();for(var t=_().get(),e=0;e<t.length;e++)A(t[e]).build();return this}}},_=function(){var e=o.val();return"0"==e&&(e=""),aids=e?e instanceof Array?e:e.split(","):[],{write:function(){return o.is("select")&&(o.empty(),aids.forEach(function(e){o.append('<option value="'+e+'">'+e+"</option>")})),o.val(aids),this},add:function(e){1==s&&(aids=[e.toString()]);var t=aids.indexOf(e.toString());return t==-1&&aids.push(e.toString()),this.write()},remove:function(e){var t=aids.indexOf(e.toString());return t!=-1&&aids.splice(t,1),this.write()},removeAll:function(){return aids=[],this.write()},get:function(){return aids}}};p.beforeFileQueued=function(t){return i.split(",").indexOf(t.ext.toLowerCase())==-1?(e.alert(e.UPLOADER_LANGUAGE.filetype.replace("{0}",i)),!1):!(s>1&&_().get().length>=s)||(e.alert(e.UPLOADER_LANGUAGE.filenum_limite.replace("{0}",s)),!1)},p.fileQueued=function(r){return o.triggerHandler("uploader.uploading",[r,_().get()])!==!1&&(v(r).init().thumb(),t>0&&a>0&&("jpg"==r.ext||"jpeg"==r.ext)?(d.uploader.upload(r),!0):(this.md5File(r).progress(function(t){v(r).progressing(0).message(e.UPLOADER_LANGUAGE.hashing+" "+(100*t).toFixed(2)+"%")}).then(function(t){e.POST(e.baseuri+"attachment/hash_query",{hash:t,_token:e.csrf,filename:r.name,ext:r.ext,size:r.size},function(a){a&&"success"==a.result?(d.uploader.skipFile(r),v(r).success().message(e.UPLOADER_LANGUAGE.hash_success),1==s&&A().removeAll(),A(a.data.id,a.data.displayname,a.data.ext).build().setFile(r),o.triggerHandler("uploader.uploaded",[r,a,_().get()])):(r.md5=t,d.uploader.upload(r))},!1)}),!0))},p.uploadBeforeSend=function(e,t,a){t.uuid=e.blob.ruid+e.file.id+e.file.size,t.start=e.start,t.end=e.end,t.chunks=e.chunks,t.chunk=e.chunk,t.total=e.file.size,t.hash=e.file.md5},p.uploadStart=function(e){},p.uploadProgress=function(e,t){o.triggerHandler("uploader.progressing",[e,t,_().get()]),v(e).progressing(t)},p.uploadSuccess=function(t,a){a&&"success"==a.result?(v(t).success(),1==s&&A().removeAll(),A(a.data.id,a.data.displayname,a.data.ext).build().setFile(t),o.triggerHandler("uploader.uploaded",[t,a,_().get()])):(v(t).error(e.UPLOADER_LANGUAGE.error+": "+a.message.content),o.triggerHandler("uploader.error",[t,a.message.content,_().get()]))},p.uploadError=function(t,a){v(t).error(e.UPLOADER_LANGUAGE.error+": "+a),o.triggerHandler("uploader.error",[t,a,_().get()])},p.uploadComplete=function(e){},p.error=function(t,a,s){switch(t){case"Q_EXCEED_NUM_LIMIT":e.alert(e.UPLOADER_LANGUAGE.num_limit.replace("{0}",a));break;case"Q_EXCEED_SIZE_LIMIT":e.alert(e.UPLOADER_LANGUAGE.allsize_limit);break;case"F_EXCEED_SIZE":e.alert(e.UPLOADER_LANGUAGE.filesize_limite.replace("{0}",bytesToSize(r)));break;case"F_DUPLICATE":e.alert(e.UPLOADER_LANGUAGE.duplicate);break;case"Q_TYPE_DENIED":e.alert(e.UPLOADER_LANGUAGE.filetype.replace("{0}",i));break;default:e.alert(t)}},d.uploader.on("beforeFileQueued",p.beforeFileQueued),d.uploader.on("fileQueued",p.fileQueued),d.uploader.on("uploadBeforeSend",p.uploadBeforeSend),d.uploader.on("uploadStart",p.uploadStart),d.uploader.on("uploadProgress",p.uploadProgress),d.uploader.on("uploadSuccess",p.uploadSuccess),d.uploader.on("uploadError",p.uploadError),d.uploader.on("uploadComplete",p.uploadComplete),d.uploader.on("error",p.error),l&&_().add(l),A().rebuildAll(),o.prop("flex_uploader",d)}})}})}(jQuery);